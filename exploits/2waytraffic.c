#include<stdio.h>
#include<stdlib.h>
#include<string.h>
#include<pcap.h>
#include"network.h"
#include"dump.h" 
#include<arpa/inet.h>	
#include<netinet/tcp.h>
#include<netinet/ip.h>	

/* Sniffs the traffic between two ip's!
Usage: 2waytraffic <src ip> <dest ip>*/  


void dec_eth(const u_char *);
int dec_ip(const u_char *,int *);
u_int dec_tcp(const u_char *);
void fatal(const char *,const char *);

void caught(u_char *,const struct pcap_pkthdr *,const u_char *);
void main(int argc, char *argv[]){
//const u_char *packet,*pkt_data;
struct pcap_pkthdr head;
char errbuf[PCAP_ERRBUF_SIZE];
char *device;
pcap_t *handle;
char fil_string[100];
struct bpf_program filter;
if(argc<2)
fatal("wrong usage!: <src ip> <dst ip>" ,NULL);

device = pcap_lookupdev(errbuf);
if(device==NULL)
fatal("looking up device" , errbuf);

printf("sniffing on device %s\n" ,device);
printf("\n________________________________________\n\n\n________________________________________\n\n");
 
handle = pcap_open_live(device,4096,1,0,errbuf);
if(handle==NULL)
fatal("pcap_open_live" ,errbuf);

sprintf(fil_string,"src host %s and dst host %s",argv[1],argv[2]);

if(pcap_compile(handle,&filter,fil_string,0,0)==-1)
fatal("while compiling",NULL);

if(pcap_setfilter(handle,&filter)==-1)
fatal("while setting filter",NULL);

while(1)
pcap_loop(handle,1,caught,argv[1]);

pcap_close(handle);
}



void caught(u_char *args,const struct pcap_pkthdr *head,const u_char *packet){

int tcp_head_len,tot_head_len,pkt_data_len,aa=0,bb=0;
u_char *pkt_data;

printf("Got a %d bytes packet\n" ,head->len);
dec_eth(packet);
aa=dec_ip(packet+ETHER_HEAD_LEN,&bb);
if(bb){
tcp_head_len = dec_tcp(packet+ETHER_HEAD_LEN+ (4*aa));
tot_head_len=ETHER_HEAD_LEN+(4*aa)+tcp_head_len;
}
else tot_head_len=ETHER_HEAD_LEN+(4*aa);
pkt_data=(u_char *)packet+tot_head_len;
pkt_data_len = head->len-tot_head_len;
if(pkt_data_len>0){
printf("%d bytes of packet data.\n" ,pkt_data_len);
dump(pkt_data,pkt_data_len);
printf("\n________________________________________\n");}
else{printf("\n________________________________________\n");}	
}

void fatal(const char *a,const char *b){
printf("Error!! %s : %s" ,a,b);
exit(0);
}


void dec_eth(const u_char *head){
struct eth_hdr *ether = (struct eth_hdr *)head;

//printf("\tLayer 2::Ethernet Header\n\n\n{{\n");

printf("Src MAC--> ");
printf("%02x" ,ether->eth_src_addr[0]);
for(int i=1;i<ETHER_ADDR_LEN;i++)
printf(":%02x" ,ether->eth_src_addr[i]);

printf("\tDst MAC--> ");
printf("%02x" ,ether->eth_dest_addr[0]);
for(int i=1;i<ETHER_ADDR_LEN;i++)
printf(":%02x" ,ether->eth_dest_addr[i]);

printf("\nType --> %hu\n" ,ntohs(ether->eth_type));

}



int dec_ip(const u_char *head,int *bb){

struct iphdr *ip = (struct iphdr *)head;
struct in_addr *ip_addr=(struct in_addr *)&(ip->saddr);
struct in_addr *ip_dest=(struct in_addr *)&(ip->daddr);

//printf("\tLayer 3:::IP Header\n\n\n{{\n");
printf("Src:%s" ,inet_ntoa(*ip_addr));
ip_addr=(struct in_addr *)&(ip->daddr);
printf(" Dst:%s" ,inet_ntoa(*ip_addr));
printf(" ID:%hu" ,ntohs(ip->id));
//printf("Type: %u\tID: %hu\tLength: %hu\n}}\n\n" ,(u_int)ip->protocol,ntohs(ip->id),ntohs(ip->tot_len));
printf("\tType: %hhu\n" ,ip->protocol);
if(ip->protocol==0x06)
*bb=1;
return ip->ihl;
}


u_int dec_tcp(const u_char *head){
u_int hdr_size;
struct tcphdr *tcp = (struct tcphdr *)head;

hdr_size= 4*(tcp->th_off);

//printf("\tLayer 4::::TCP Header\n\n\n{{\n");
printf(" Seq #: %u Ack #: %u " ,ntohl(tcp->th_seq),ntohl(tcp->th_ack));
printf("SrcPort: %hu DstPort: %hu " ,ntohs(tcp->th_sport),ntohs(tcp->th_dport));
//printf("Header Size: %u Flags: " ,hdr_size);
printf("Flags: ");
if(tcp->th_flags & TH_FIN)
printf("FIN ");
if(tcp->th_flags & TH_SYN)
printf("SYN ");
if(tcp->th_flags & TH_RST)
printf("RST ");
if(tcp->th_flags & TH_PUSH)
printf("PUSH ");
if(tcp->th_flags & TH_ACK)
printf("ACK ");
if(tcp->th_flags & TH_URG)
printf("URG ");
//printf("\n}}\n\n");

return hdr_size;
}




















