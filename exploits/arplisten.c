#include<stdio.h>
#include<stdlib.h>
#include<string.h>
#include<pcap.h>
#include"network.h"
#include"dump.h" 
#include<arpa/inet.h>		

/* Lstens for the ARP traffic on the network!*/

void dec_eth(const u_char *);
u_int dec_ip(const u_char *,int *);
u_int dec_tcp(const u_char *);
void dec_arp(const u_char *);
void fatal(const char *,const char *);

void caught(u_char *,const struct pcap_pkthdr *,const u_char *);

void main(){
//const u_char *packet,*pkt_data;
struct pcap_pkthdr head;
char errbuf[PCAP_ERRBUF_SIZE];
char *device;
struct bpf_program filter;
char filter_string[]="arp";
pcap_t *handle;

device = pcap_lookupdev(errbuf);
if(device==NULL)
fatal("looking up device" , errbuf);

printf("sniffing on device %s\n" ,device);
printf("\n________________________________________\n\n\n________________________________________\n\n");
 
handle = pcap_open_live(device,4096,1,0,errbuf);
if(handle==NULL)
fatal("pcap_open_live" ,errbuf);

if(pcap_compile(handle,&filter,filter_string,0,0)==-1)
fatal("pcap compile failed",NULL);

if(pcap_setfilter(handle,&filter)==-1)
fatal("failed to set filter",NULL);

while(1)
pcap_loop(handle,1,caught,NULL);

pcap_close(handle);
}



void caught(u_char *args,const struct pcap_pkthdr *head,const u_char *packet){

int tcp_head_len,tot_head_len,pkt_data_len,aa,bb;
u_char *pkt_data;

//printf("Got a %d bytes packet\n" ,head->len);

dec_eth(packet);
dec_arp(packet+ETHER_HEAD_LEN);

tot_head_len=ETHER_HEAD_LEN+sizeof(struct arp_hdr);
pkt_data=(u_char *)packet+tot_head_len;
pkt_data_len = head->len-tot_head_len;
if(pkt_data_len>0){
printf("\n%d bytes of packet data:\n" ,pkt_data_len);
dump(pkt_data,pkt_data_len);
printf("\n________________________________________\n\n\n________________________________________\n\n");}
else{printf("\n\t\tNo packet data\n________________________________________\n\n\n________________________________________\n\n");}

}

void fatal(const char *a,const char *b){
printf("Error!! %s : %s" ,a,b);
exit(0);
}


void dec_eth(const u_char *head){
struct eth_hdr *ether = (struct eth_hdr *)head;

printf("\tLayer 2::Ethernet Header\n\n\n{{\n");

printf("Source MAC address --> ");
printf("%02x" ,ether->eth_src_addr[0]);
for(int i=1;i<ETHER_ADDR_LEN;i++)
printf(":%02x" ,ether->eth_src_addr[i]);

printf("\tDestination MAC address --> ");
printf("%02x" ,ether->eth_dest_addr[0]);
for(int i=1;i<ETHER_ADDR_LEN;i++)
printf(":%02x" ,ether->eth_dest_addr[i]);

printf("\nType --> %hu\n}}\n\n" ,ntohs(ether->eth_type));
}



u_int dec_ip(const u_char *head,int *aa){
*aa=0;
struct ip_hdr *ip = (struct ip_hdr *)head;
struct in_addr *ip_addr=(struct in_addr *)&(ip->ip_src_addr);


printf("\tLayer 3:::IP Header\n\n\n{{\n");

printf("Source: %s" ,inet_ntoa(*ip_addr));
ip_addr=(struct in_addr *)&(ip->ip_dest_addr);
printf("\tDestination: %s\n" ,inet_ntoa(*ip_addr));
printf("Type: %u\tID: %hu\tLength: %hu\n}}\n\n" ,(u_int)ip->ip_type,ntohs(ip->ip_id),ntohs(ip->ip_len));
if(ip->ip_type==6)
*aa=1;
return ip->ip_head_len;
}


u_int dec_tcp(const u_char *head){
u_int hdr_size;
struct tcp_hdr *tcp = (struct tcp_hdr *)head;

hdr_size= 4*(tcp->tcp_offset);

printf("\tLayer 4::::TCP Header\n\n\n{{\n");
printf("Source Port: %hu\tDestination Port: %hu\n" ,ntohs(tcp->tcp_src_port),ntohs(tcp->tcp_dest_port));
printf("Seq #: %u\tAck #: %u\n" ,ntohl(tcp->tcp_seq),ntohl(tcp->tcp_ack));
printf("Header Size: %u\tFlags: " ,hdr_size);
if(tcp->tcp_flags & TCP_FIN)
printf("FIN ");
if(tcp->tcp_flags & TCP_SYN)
printf("SYN ");
if(tcp->tcp_flags & TCP_RST)
printf("RST ");
if(tcp->tcp_flags & TCP_PUSH)
printf("PUSH ");
if(tcp->tcp_flags & TCP_ACK)
printf("ACK ");
if(tcp->tcp_flags & TCP_URG)
printf("URG ");
printf("\n}}\n\n");

return hdr_size;
}


void dec_arp(const u_char *head){

struct arp_hdr *arp = (struct arp_hdr *)head;

printf("\tLayer 3:::ARP Header\n\n\n{{\n");
printf("Hardware Protocol: %hu\tProtocol Type: %hu\n" ,ntohs(arp->htype),ntohs(arp->ptype));
printf("HLength: %02d\tPLength: %02d\t" ,arp->hlen,arp->plen);
printf("Opcode: %hu\n" ,ntohs(arp->opcode));
printf("Sender Haddr: ");
printf("%02x" ,arp->sha[0]);
for(int i=1;i<6;i++)
printf(":%02x" ,arp->sha[i]);

printf("\tSender IP: ");
printf("%d" ,arp->spa[0]);
for(int i=1;i<4;i++)
printf(".%d" ,arp->spa[i]);

printf("\nTarget Haddr: ");
printf("%02x" ,arp->tha[0]);
for(int i=1;i<6;i++)
printf(":%02x" ,arp->tha[i]);

printf("\tTarget IP: ");
printf("%d" ,arp->tpa[0]);
for(int i=1;i<4;i++)
printf(".%d" ,arp->tpa[i]);
}



















