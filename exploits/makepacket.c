#include"headers.h"
#include"fatal.h"
#include"dump.h"
#include<linux/if.h>
#include"prand.h"
#include<linux/if_packet.h>
#include <sys/file.h>
#include <linux/raw.h>
#include"../head/build.h"
#include<netinet/if_ether.h>
#include<unistd.h>
#define ETH_HEAD_LEN 14
/* ARP Poisons two devices with the MAC of 'this' device!*/  










struct pseudo_header
{
    u_int32_t source_address;
    u_int32_t dest_address;
    u_int8_t placeholder;
    u_int8_t protocol;
    u_int16_t tcp_length;
};

unsigned short csum(unsigned short *ptr,int nbytes) 
{
    register long sum;
    unsigned short oddbyte;
    register short answer;
 
    sum=0;
    while(nbytes>1) {
        sum+=*ptr++;
        nbytes-=2;
    }
    if(nbytes==1) {
        oddbyte=0;
        *((u_char*)&oddbyte)=*(u_char*)ptr;
        sum+=oddbyte;
    }
 
    sum = (sum>>16)+(sum & 0xffff);
    sum = sum + (sum>>16);
    answer=(short)~sum;
     
    return(answer);
}






















struct ifreq ifr;
struct ifreq ifr_idx;
struct sockaddr_ll address;

void main(int argc,char *argv[]){

struct sockaddr_in sin;

u_char packet1[ETHER_HEAD_LEN+sizeof(struct ip_hdr)+sizeof(struct tcp_hdr)+20],errbuf[PCAP_ERRBUF_SIZE];
int sock;
u_char mac_src[20],*device,*mac,source_ip[32],*pseudogram;
struct pseudo_header psh;
struct ip_hdr *ip;
struct tcp_hdr *tcp;
memset(mac_src,0,20);
memset(&ifr,0,sizeof(struct ifreq));
memset(&ifr_idx,0,sizeof(struct ifreq));
memset(&address,0,sizeof(struct sockaddr_in));
memset(packet1,0,ETHER_HEAD_LEN+sizeof(struct arp_hdr));


if(argc<3)
fatal("wrong usage:makepacket <source IP> <dest IP>!");

if((device = pcap_lookupdev(errbuf))==NULL)
fatal("looking up device");

memset(&sin,0,sizeof(struct sockaddr_in));		//here

strncpy(ifr.ifr_name,device,6);
strncpy(ifr_idx.ifr_name,device,6);

sock=socket(AF_INET,SOCK_RAW,IPPROTO_RAW);
if(sock==-1)
fatal("in socket");

if(ioctl(sock,SIOCGIFHWADDR,&ifr)==-1)
fatal("ioctl hwaddr");
if(ioctl(sock,SIOCGIFINDEX,&ifr_idx)==-1)
fatal("ioctl index");

sin.sin_family=AF_INET;
sin.sin_port=htons(80);
sin.sin_addr.s_addr=inet_addr(argv[2]);

address.sll_family=AF_PACKET;
address.sll_protocol  = htons(ETH_P_ALL);
address.sll_ifindex=ifr_idx.ifr_ifindex;
address.sll_halen=ETHER_ADDR_LEN;

mac=ifr.ifr_hwaddr.sa_data;
sprintf(mac_src,"%hhx:%hhx:%hhx:%hhx:%hhx:%hhx",mac[0],mac[1],mac[2],mac[3],mac[4],mac[5]);

build_eth(packet1,"b8:c1:a2:10:9c:54",mac_src);
ip=(struct ip_hdr *)(packet1+ETH_HEAD_LEN);
tcp=(struct tcp_hdr *)(packet1+ETH_HEAD_LEN+sizeof(struct ip_hdr));


strcpy(source_ip,argv[1]);

ip->ip_ver=4;
ip->ip_head_len=5;
ip->ip_tos=0;
ip->ip_len=sizeof(struct ip_hdr)+sizeof(struct tcp_hdr)+20;
ip->ip_id=htonl(54321);
ip->ip_frag_offset=0;
ip->ip_ttl=255;
ip->ip_type=IPPROTO_TCP;
ip->ip_checksum=0;
ip->ip_src_addr=inet_addr(source_ip);
ip->ip_dest_addr=sin.sin_addr.s_addr;

ip->ip_checksum=csum((unsigned short *)packet1,ip->ip_len);

libnet_seed_prand();

tcp->tcp_src_port=htons(80);
tcp->tcp_dest_port=htons(49717);					//MODIFY!
tcp->tcp_seq=libnet_get_prand(LIBNET_PRu32);
tcp->tcp_ack=libnet_get_prand(LIBNET_PRu32);
tcp->tcp_offset=5;
tcp->tcp_flags=TCP_SYN;
tcp->tcp_window=htons(5840);
tcp->tcp_checksum=0;
tcp->tcp_urgent=0;

psh.source_address = inet_addr( source_ip );
psh.dest_address = sin.sin_addr.s_addr;
psh.placeholder = 0;
psh.protocol = IPPROTO_TCP;
psh.tcp_length = htons(sizeof(struct tcp_hdr) + 20 );
     
int psize = sizeof(struct pseudo_header) + sizeof(struct tcp_hdr) + 20;
pseudogram = malloc(psize);
     
memcpy(pseudogram , (char*) &psh , sizeof (struct pseudo_header));
memcpy(pseudogram + sizeof(struct pseudo_header) , tcp , sizeof(struct tcp_hdr) + 20);

int one = 1;
const int *val = &one;

tcp->tcp_checksum = csum( (unsigned short*) pseudogram , psize);

if (setsockopt (sock, IPPROTO_IP, IP_HDRINCL, val, sizeof (one)) < 0)
fatal("while setting socket options");

dec_eth(packet1);
dec_ip(packet1+ETHER_HEAD_LEN);
dec_tcp(packet1+ETHER_HEAD_LEN+sizeof(struct ip_hdr));


for(int i=0;i<65536;i++){
tcp->tcp_dest_port=htons(i);
ip->ip_checksum=csum((unsigned short *)packet1,ip->ip_len);
tcp->tcp_checksum = csum( (unsigned short*) pseudogram , psize);
if(sendto(sock,packet1,ip->ip_len,0,(struct sockaddr *)&sin, sizeof(sin))<0)		
fatal("while sending the packet");
else printf("packet sent, size = %d\n" ,ip->ip_len+14);	
usleep(1000);			
}			

/*
dec_eth(packet1);
dec_arp(packet1+ETHER_HEAD_LEN);
*/

/*while(1){
if((sendto(sock,packet1,ETHER_HEAD_LEN+sizeof(struct arp_hdr),0,(struct sockaddr *)&address,sizeof(address)))==-1)
fatal("while sending the 1st packet");

if((sendto(sock,packet2,ETHER_HEAD_LEN+sizeof(struct arp_hdr),0,(struct sockaddr *)&address,sizeof(address)))==-1)
fatal("while sending the 2nd packet");

printf("packets injected!\n");
usleep(5000000);
}*/


}








 

