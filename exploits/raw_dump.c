#include<stdio.h>
#include<stdlib.h>
#include<string.h>
#include<pcap.h>
#include"network.h"
#include"dump.h" 
#include<arpa/inet.h>		

/*Sniffs all the traffic on the network!
use "sudo ./traffic_sniffer | grep -B NUM -A NUM word" to print NUM lines before and after the "word"!
*/


void dec_eth(const u_char *);
u_int dec_ip(const u_char *);
u_int dec_tcp(const u_char *);
void fatal(const char *,const char *);

void caught(u_char *,const struct pcap_pkthdr *,const u_char *);

void main(){
//const u_char *packet,*pkt_data;
struct pcap_pkthdr head;
char errbuf[PCAP_ERRBUF_SIZE];
char *device;
pcap_t *handle;

device = pcap_lookupdev(errbuf);
if(device==NULL)
fatal("looking up device" , errbuf);

printf("sniffing on device %s\n" ,device);
printf("\n________________________________________\n\n\n________________________________________\n\n");
 
handle = pcap_open_live(device,4096,1,0,errbuf);
if(handle==NULL)
fatal("pcap_open_live" ,errbuf);
while(1)
pcap_loop(handle,1,caught,NULL);

pcap_close(handle);
}



void caught(u_char *args,const struct pcap_pkthdr *head,const u_char *packet){

int tcp_head_len,tot_head_len,pkt_data_len,aa=0;
u_char *pkt_data;

printf("Got a %d bytes packet\n" ,head->len);

dump(packet,head->len);	
}

void fatal(const char *a,const char *b){
printf("Error!! %s : %s" ,a,b);
exit(0);
}


















