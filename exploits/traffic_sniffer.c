#include<stdio.h>
#include<stdlib.h>
#include<string.h>
#include<pcap.h>
#include"network.h"
#include"dump.h" 
#include<arpa/inet.h>		

/*Sniffs all the traffic on the network!
use "sudo ./traffic_sniffer | grep -B NUM -A NUM word" to print NUM lines before and after the "word"!
*/


void dec_eth(const u_char *);
u_int dec_ip(const u_char *);
u_int dec_tcp(const u_char *);
void fatal(const char *,const char *);

void caught(u_char *,const struct pcap_pkthdr *,const u_char *);

void main(){
//const u_char *packet,*pkt_data;
struct pcap_pkthdr head;
char errbuf[PCAP_ERRBUF_SIZE];
char *device;
pcap_t *handle;

device = pcap_lookupdev(errbuf);
if(device==NULL)
fatal("looking up device" , errbuf);

printf("sniffing on device %s\n" ,device);
printf("\n________________________________________\n\n\n________________________________________\n\n");
 
handle = pcap_open_live(device,4096,1,0,errbuf);
if(handle==NULL)
fatal("pcap_open_live" ,errbuf);
while(1)
pcap_loop(handle,1,caught,NULL);

pcap_close(handle);
}



void caught(u_char *args,const struct pcap_pkthdr *head,const u_char *packet){

int tcp_head_len,tot_head_len,pkt_data_len,aa=0;
u_char *pkt_data;

printf("Got a %d bytes packet\n" ,head->len);

dec_eth(packet);
if((aa=dec_ip(packet+ETHER_HEAD_LEN))>0){
aa*=4;
tcp_head_len = dec_tcp(packet+ETHER_HEAD_LEN+aa);

tot_head_len=ETHER_HEAD_LEN+aa+tcp_head_len;}
else tot_head_len=ETHER_HEAD_LEN+aa;
pkt_data=(u_char *)packet+tot_head_len;
pkt_data_len = head->len-tot_head_len;
if(pkt_data_len>0){
printf("%d bytes of packet data:\n" ,pkt_data_len);
dump(pkt_data,pkt_data_len);
printf("\n________________________________________\n\n\n________________________________________\n\n");}
else{printf("\n\t\tNo packet data\n________________________________________\n\n\n________________________________________\n\n");}
	
}

void fatal(const char *a,const char *b){
printf("Error!! %s : %s" ,a,b);
exit(0);
}


void dec_eth(const u_char *head){
struct eth_hdr *ether = (struct eth_hdr *)head;

printf("\tLayer 2::Ethernet Header\n\n\n{{\n");

printf("Source MAC address --> ");
printf("%02x" ,ether->eth_src_addr[0]);
for(int i=1;i<ETHER_ADDR_LEN;i++)
printf(":%02x" ,ether->eth_src_addr[i]);

printf("\tDestination MAC address --> ");
printf("%02x" ,ether->eth_dest_addr[0]);
for(int i=1;i<ETHER_ADDR_LEN;i++)
printf(":%02x" ,ether->eth_dest_addr[i]);

printf("\nType --> %hu\n}}\n\n" ,ether->eth_type);

}



u_int dec_ip(const u_char *head){

struct ip_hdr *ip = (struct ip_hdr *)head;
struct in_addr *ip_addr=(struct in_addr *)&(ip->ip_src_addr);


printf("\tLayer 3:::IP Header\n\n\n{{\n");

printf("Source: %s" ,inet_ntoa(*ip_addr));
ip_addr=(struct in_addr *)&(ip->ip_dest_addr);
printf("\tDestination: %s\n" ,inet_ntoa(*ip_addr));
printf("Type: %u\tID: %hu\tLength: %hu\n}}\n\n" ,(u_int)ip->ip_type,ntohs(ip->ip_id),ntohs(ip->ip_len));
if(ip->ip_type==6)
return ip->ip_head_len;
else return 0;
}


u_int dec_tcp(const u_char *head){
u_int hdr_size;
struct tcp_hdr *tcp = (struct tcp_hdr *)head;

hdr_size= 4*(tcp->tcp_offset);

printf("\tLayer 4::::TCP Header\n\n\n{{\n");
printf("Source Port: %hu\tDestination Port: %hu\n" ,ntohs(tcp->tcp_src_port),ntohs(tcp->tcp_dest_port));
printf("Seq #: %u\tAck #: %u\n" ,ntohl(tcp->tcp_seq),ntohl(tcp->tcp_ack));
printf("Header Size: %u\tFlags: " ,hdr_size);
if(tcp->tcp_flags & TCP_FIN)
printf("FIN ");
if(tcp->tcp_flags & TCP_SYN)
printf("SYN ");
if(tcp->tcp_flags & TCP_RST)
printf("RST ");
if(tcp->tcp_flags & TCP_PUSH)
printf("PUSH ");
if(tcp->tcp_flags & TCP_ACK)
printf("ACK ");
if(tcp->tcp_flags & TCP_URG)
printf("URG ");
printf("\n}}\n\n");

return hdr_size;
}




















