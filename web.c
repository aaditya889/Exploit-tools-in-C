#include<stdio.h>
#include<stdlib.h>
#include<string.h>
#include<fcntl.h>
#include<sys/stat.h>
#include<sys/socket.h>
#include<netinet/in.h>
#include<arpa/inet.h>
#include"C/head/fatal.h"
#include<unistd.h>

#define PORT 80								//default port the which the client will request!
#define WEBROOT "/media/root/Dell/Documents/Aaditya/Hack"		//the default 'base' address for any file requested by the client! 

void handle(int);
int filesize(int);
void send_bytes(int,char *);

int main(){

int sh,sc,yes=1,fd,file,reclen=1,tem;
char buf[100],*fileptr;
struct sockaddr_in host,client;						//sockaddr_in struct for host and client info.
socklen_t size;
 	
if((sh=socket(PF_INET,SOCK_STREAM,0))==-1)					//open up a socket
fatal("instantiating socket");

if((setsockopt(sh,SOL_SOCKET,SO_REUSEADDR,&yes,sizeof(int)))==-1)		//socket options (find out more!)
fatal("setting socket options");

if(setsockopt(sh,SOL_SOCKET,SO_REUSEPORT,&yes,sizeof(int))==-1)			// more socket options (more)
fatal("while setting 2nd socket options");

host.sin_family = AF_INET;
host.sin_port = htons(PORT);
host.sin_addr.s_addr = INADDR_ANY;
memset(&host.sin_zero,'\0',8);

if((bind(sh,(struct sockaddr *)&host,sizeof(struct sockaddr)))==-1)		//binding and passing the host struct
fatal("while binding");

if((listen(sh,20))==-1)								//listening
fatal("listening");

while(1){									//infinite loop to address any number of clients
size=sizeof(struct sockaddr_in);
if((sc=accept(sh,(struct sockaddr *)&client,&size))==-1)	//accepting requests and filling the client info in client sockaddr struct
fatal("while accepting");
printf("got a request from %s:%d -->" ,inet_ntoa(client.sin_addr),ntohs(client.sin_port));
handle(sc);									//handle a particular request
}
}




void handle(int sock){								//begin handle
int reclen,fd,file;
char msg[1000],req[500],*fileptr;
char *ptr;

reclen=recv(sock,msg,1000,0);
printf("%s" ,msg);

if((ptr=strstr(msg," HTTP/"))!=NULL){

*ptr=0;									//if it's an http request, remove the 'http' part of the request

if(strncmp(msg,"GET ",4)==0){
ptr=msg+4;						//place the pointer after the get request, to find the name of the requested file
if(ptr[strlen(ptr)-1]=='/')				//if requested file is '/', it's the first request for the index.html file!
strcat(ptr,"index.html");
strcpy(req,WEBROOT);					
strcat(req,ptr);					//else it's another file.
printf("\n\nfile--->>%s\n\n" ,req);
if((fd=open(req,O_RDONLY,0))==-1){			//if the is file not found, start sending this msg to the client browser.....
printf("404 file not found\n");
send_bytes(sock, "HTTP/1.0 404 NOT FOUND\r\n");
send_bytes(sock, "<html><head><title>404 Not Found</title></head>");
send_bytes(sock, "<body><h1>URL not found</h1></body></html>\r\n");		//.....till here
}
else{							//if the file is found, send this.....
send_bytes(sock,"HTTP/1.1 200 OK\r\n");		//let the browser know that the file is found!		
file=filesize(fd);				//'fd' is the file descriptor of the requested file, and file is thr file size.
fileptr=(char *)malloc(file);			//'fileptr' will be the
read(fd,fileptr,file);				//starting pointer of the files' data.	
if(send(sock,fileptr,file,0))			//sending the requested file.
printf("file sent!\n");
else printf("unable to send!");
free(fileptr);					//free the file ptr created
}
close(fd);					//close the file.

}
}
shutdown(sock,SHUT_RDWR);			//close the connection with the client after the request is completed.

}										//end handle!



int filesize(int fd){				//get the file size from the file descriptor
struct stat Stat;
if((fstat(fd,&Stat))==-1)
fatal("while getting file size");
return (int)Stat.st_size;
}						//end filesize function


void send_bytes(int fd,char *p){	//send the passed char ptr to the passed socket 
int len=strlen(p),sent;			//the char ptr should have a terminating character ('\0')
while(len>0){
if((sent=send(fd,p,len,0))==-1)
fatal("while sending");
len-=sent;
p+=sent;
}
send(fd,"\r\n",2,0);

}					//end send_bytes function.







	
